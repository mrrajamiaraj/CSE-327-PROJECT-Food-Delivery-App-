{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Location Access</title>
  <link rel="stylesheet" href="{% static 'css/location.css' %}">
</head>
<body>
  <div class="screen"><div class="phone">
    <div class="wrap">
      <div class="hero"><img src="{% static 'img/map-illustration.png' %}" alt="Map"></div>
      <h2 class="title">Allow Location</h2>
      <p class="note">We use your location to show nearby restaurants and delivery time.</p>
      <button id="askBtn" class="btn">ACCESS LOCATION</button>
      <p class="note">We access your location only while using the app.</p>
      <p id="err" class="bad hidden"></p>
    </div>
  </div></div>

  <script>
    const askBtn=document.getElementById('askBtn'), errEl=document.getElementById('err');
    function saveAndGo(lat,lon){
      localStorage.setItem('user_location',JSON.stringify({lat,lon,ts:Date.now()}));
      window.location.href="{% url 'dashboard' %}";
    }
    function showErr(msg){errEl.textContent=msg;errEl.classList.remove('hidden')}
    askBtn.addEventListener('click',()=>{
      errEl.classList.add('hidden');
      if(!('geolocation'in navigator)){showErr('Location not supported on this device.');return}
      askBtn.disabled=true;askBtn.textContent='Requestingâ€¦';
      navigator.geolocation.getCurrentPosition(
        (pos)=>{const {latitude,longitude}=pos.coords;saveAndGo(latitude,longitude)},
        (err)=>{askBtn.disabled=false;askBtn.textContent='ACCESS LOCATION';
          showErr(err.code===err.PERMISSION_DENIED?'Permission denied. Enable location in settings.':'Unable to get location. Try again.')},
        {enableHighAccuracy:true,timeout:12000,maximumAge:0}
      );
    });
  </script>
</body>
</html>